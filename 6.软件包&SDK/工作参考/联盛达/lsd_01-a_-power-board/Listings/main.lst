C51 COMPILER V9.54   MAIN                                                                  07/23/2024 15:40:40 PAGE 1   


C51 COMPILER V9.54, COMPILATION OF MODULE MAIN
OBJECT MODULE PLACED IN .\Objects\main.obj
COMPILER INVOKED BY: C:\Keil_v5\C51\BIN\C51.EXE USER\main.c LARGE OPTIMIZE(8,SPEED) BROWSE INCDIR(.\inc;.\USER) DEBUG OB
                    -JECTEXTEND PRINT(.\Listings\main.lst) OBJECT(.\Objects\main.obj)

line level    source

   1          #include "main.h"
   2           
   3          DirectOutputType        DirectOutput       ={0};
   4          volatile LoopUartType   LoopUart            ={0};
   5          LampCtrlTypedef         LampCtrl            ={0};
   6          
   7          u8 cmd_buffer[64]={0};
   8          u16 volatile UartTimeOutCount =0; // 超时计数器
   9          u32 ProcessCount =0;
  10          
  11          //芯片初始化
  12          void MCU_init(void)
  13          {
  14   1          Gpio_init();
  15   1          Uart_Init();
  16   1          Flow_Init();
  17   1          ADC_Init();
  18   1          TIMER0_initialize();
  19   1          QueueInit(&LoopUart);
  20   1          EA  =1;
  21   1      }
  22          
  23          void OutPutCtrl(void)//输出控制
  24          {
  25   1          static u8 step=0;
  26   1          switch (step)
  27   1          {
  28   2          case 0:
  29   2              (DirectOutput.OutputCtrlBit.Valve_1==High_ON)?(RL1=High_ON):(RL1=Low_OFF);
  30   2              step++;
  31   2              break;
  32   2          case 1:
  33   2              (DirectOutput.OutputCtrlBit.Valve_2==High_ON)?(RL2=High_ON):(RL2=Low_OFF);
  34   2              step++;
  35   2              break;
  36   2          case 2:
  37   2              (DirectOutput.OutputCtrlBit.Valve_3==High_ON)?(RL3=High_ON):(RL3=Low_OFF);
  38   2              step++;
  39   2              break;
  40   2          case 3:
  41   2              (DirectOutput.OutputCtrlBit.Valve_4==High_ON)?(RL4=High_ON):(RL4=Low_OFF);
  42   2              step++;
  43   2              break;
  44   2          case 4:
  45   2              (DirectOutput.OutputCtrlBit.Valve_5==High_ON)?(RL5=High_ON):(RL5=Low_OFF);
  46   2              step++;
  47   2              break;
  48   2          case 5:
  49   2              (DirectOutput.OutputCtrlBit.Valve_6==High_ON)?(RL6=High_ON):(RL6=Low_OFF);
  50   2              step++;
  51   2              break;
  52   2          case 6:
  53   2              (DirectOutput.OutputCtrlBit.Pump==High_ON)?(SCR2=Low_ON):(SCR2=High_OFF);
  54   2              step++;
C51 COMPILER V9.54   MAIN                                                                  07/23/2024 15:40:40 PAGE 2   

  55   2              break;
  56   2          default:
  57   2              step =0;
  58   2              break;
  59   2          }
  60   1      }
  61          
  62          void ProcessMessage(PCTRL_MSG msg)//照明处理
  63          {
  64   1          u8 cmdType = msg->cmd_type;
  65   1          u8 len     = msg->cmd_len;
  66   1          u8 Ack     = 0; 
  67   1          switch (cmdType)
  68   1          {
  69   2          case CMD_SteamHeat:
  70   2          memcpy(&SteamHeatCtrl,msg->param,sizeof(DutyCycleOutputType));
  71   2          DataFrameTransmission(&Ack,CMD_SteamHeat,sizeof(Ack));
  72   2      
  73   2              break;
  74   2          case CMD_SteamPump:
  75   2          memcpy(&SteamPumpCtrl,msg->param,sizeof(DutyCycleOutputType));
  76   2          DataFrameTransmission(&Ack,CMD_SteamPump,sizeof(Ack));
  77   2      
  78   2              break;
  79   2          case CMD_DirOutput:
  80   2          memcpy(&DirectOutput,msg->param,sizeof(DirectOutputType));  
  81   2          DataFrameTransmission(&Ack,CMD_DirOutput,sizeof(Ack));
  82   2              
  83   2              break;
  84   2          case CMD_LampCtrl:
  85   2          memcpy(&LampCtrl,msg->param,sizeof(LampCtrlTypedef));
  86   2          DataFrameTransmission(&Ack,CMD_LampCtrl,sizeof(Ack));
  87   2      
  88   2              break;
  89   2          case CMD_ADSensor:
  90   2          DataFrameTransmission(&AdPara,CMD_ADSensor,sizeof(AdParaTypedef));
  91   2          UartTimeOutCount =0;
  92   2      
  93   2              break;
  94   2          case CMD_Flow: 
  95   2          DataFrameTransmission(&CurFlow,CMD_Flow,sizeof(CurFlow));
  96   2      
  97   2              break;
  98   2          case CMD_FlowCtrl:
  99   2          memcpy(&FlowCtrl,msg->param,sizeof(FlowCtrlTypedef));
 100   2          DataFrameTransmission(&Ack,CMD_FlowCtrl,sizeof(Ack));
 101   2              break;
 102   2          default:
 103   2              break;
 104   2          }
 105   1      }
 106          void SerialPortDataRefresh()//串口数据刷新
 107          {
 108   1          if(QueueFinDataFrame(&LoopUart,cmd_buffer)>0)
 109   1              ProcessMessage((PCTRL_MSG)cmd_buffer);
 110   1      }
 111          
 112          
 113          
 114          void Lamp_Ctrl()//照明控制
 115          {
 116   1          static u8 PeriodCount =0;
C51 COMPILER V9.54   MAIN                                                                  07/23/2024 15:40:40 PAGE 3   

 117   1          PeriodCount++;
 118   1          switch (LampCtrl.CtrlByte)
 119   1          {
 120   2          case FULL_POWER:
 121   2              LAMP =High_ON; 
 122   2              break;
 123   2          case All_Down:
 124   2              LAMP = Low_OFF; 
 125   2              break;
 126   2          case REDUCTION:
 127   2          if(PeriodCount<=LampCtrl.DutyCount)
 128   2              LAMP = High_ON;
 129   2          else if(PeriodCount<=PERIOD_20MS)
 130   2              LAMP = Low_OFF;
 131   2          else
 132   2              PeriodCount =0;
 133   2              break;
 134   2          default:
 135   2              LAMP = Low_OFF;
 136   2              break;
 137   2          }
 138   1      }
 139          
 140          
 141          void main(void)
 142          {
 143   1          MCU_init();//初始化
 144   1          while (1)
 145   1          {
 146   2             SerialPortDataRefresh();//串口接收处理
 147   2             if(Time10MS>=DIV_10MS)//每10ms执行一次
 148   2             {
 149   3                  Time10MS=0; 
 150   3                  // 通讯超时关闭所有输出
 151   3                  if(UartTimeOutCount>=UART_TIMEOUT_COUNT)//串口通讯超时
 152   3                  {
 153   4                      DirectOutput.OutputCtrlByte = 0; //清空输出
 154   4                      SteamHeatCtrl.workFlag = 0;             //关闭蒸汽
 155   4                      SteamPumpCtrl.workFlag = 0;             //关闭蒸汽堡
 156   4                      OutPutCtrl();
 157   4                  }
 158   3                  else
 159   3                  {
 160   4                      UartTimeOutCount++;//每10ms自增一次
 161   4                      Flow_Ctrl();
 162   4                      Lamp_Ctrl();
 163   4                      CheckSensor();
 164   4                      OutPutCtrl();
 165   4                  }
 166   3             }
 167   2          }
 168   1      }
 169          


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    737    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =    207       5
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----    ----
C51 COMPILER V9.54   MAIN                                                                  07/23/2024 15:40:40 PAGE 4   

   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
