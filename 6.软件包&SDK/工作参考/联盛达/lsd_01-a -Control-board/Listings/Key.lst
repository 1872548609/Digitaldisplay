C51 COMPILER V9.54   KEY                                                                   07/12/2025 08:10:59 PAGE 1   


C51 COMPILER V9.54, COMPILATION OF MODULE KEY
OBJECT MODULE PLACED IN .\Objects\Key.obj
COMPILER INVOKED BY: E:\keilC51\C51\BIN\C51.EXE scr\Key.c OPTIMIZE(9,SIZE) BROWSE INCDIR(.\inc;.\USER) DEBUG OBJECTEXTEN
                    -D PRINT(.\Listings\Key.lst) TABS(2) OBJECT(.\Objects\Key.obj)

line level    source

   1          #include "Key.h"
   2          
   3          KeyParaTypedef xdata KeyPara ={0};
   4          
   5          #define Key_Power       0x01 
   6          #define Key_Grind       0x02
   7          #define Key_Temp        0x04
   8          #define Key_Clean       0x08
   9          #define Key_Steam       0x10
  10          #define Key_Hotwater    0x20
  11          #define Key_Extract     0x40
  12          
  13          #define KeyDelay_20MS   2 //æŒ‰é”®å»¶æ—¶20MS 
  14          #define KeyDelay_3S     300 //æŒ‰é”®å»¶æ—¶3S 
  15          #define KeyDelay_5S     500 //æŒ‰é”®å»¶æ—¶5S 
  16          
  17          #define Key_on          0x00 
  18          #define Key_off         0x01 
  19          
  20          void Scan()
  21          {
  22   1          u8 KeyValue = 0;
  23   1          if(PowerKey     == Key_on) KeyValue |= Key_Power;
  24   1          if(GrindKey     == Key_on) KeyValue |= Key_Grind;
  25   1          if(TempKey      == Key_on) KeyValue |= Key_Temp;
  26   1          if(CleanKey     == Key_on) KeyValue |= Key_Clean;
  27   1          if(SteamKey     == Key_on) KeyValue |= Key_Steam;
  28   1          if(HotWaterKey  == Key_on) KeyValue |= Key_Hotwater;
  29   1          if(ExtractKey   == Key_on) KeyValue |= Key_Extract;
  30   1      
  31   1          if(0 == KeyValue)
  32   1          {
  33   2              if(KeyPara.PreKey == Key_Power)KeyPara.CurKey= Key_Power;
  34   2              else if(KeyPara.PreKey == Key_Grind)KeyPara.CurKey= Key_Grind;
  35   2              else if(KeyPara.PreKey == Key_Temp)KeyPara.CurKey= Key_Temp;
  36   2              else if(KeyPara.PreKey == Key_Clean)KeyPara.CurKey= Key_Clean;
  37   2              else if(KeyPara.PreKey == Key_Steam)KeyPara.CurKey= Key_Steam;
  38   2              else if(KeyPara.PreKey == Key_Hotwater)KeyPara.CurKey= Key_Hotwater;
  39   2              else if(KeyPara.PreKey == Key_Extract)KeyPara.CurKey= Key_Extract;
  40   2      
  41   2              KeyPara.PreKey = 0;
  42   2              KeyPara.FilterCount = 0;
  43   2          }
  44   1          else if (KeyPara.PreKey == KeyValue)
  45   1          {
  46   2              SleepCut = 0;
  47   2              KeyPara.FilterCount++; 
  48   2              if (KeyPara.FilterCount>= KeyDelay_5S)
  49   2              {
  50   3                  if(DeviceStatus == status_Idle)
  51   3                  {
  52   4                      if(KeyPara.PreKey == (Key_Steam|Key_Hotwater))
  53   4                      {
  54   5                          KeyPara.FilterCount = 0;
C51 COMPILER V9.54   KEY                                                                   07/12/2025 08:10:59 PAGE 2   

  55   5                          LT.CleanTask.Logictrl.LogictrlBit.execute=1;
  56   5                          Dis_PilotLamp(Led_Power|Led_HotWater|Led_Steam);
  57   5                          CodeDis(CLN,0);
  58   5                          buzctrl.BeepState   = BeepOnce;
  59   5                          buzctrl.BeepDuration= Buz_1S;
  60   5                          DeviceStatus = status_Clean;
  61   5                      }
  62   4                  }
  63   3                  else if (DeviceStatus == status_Clean)
  64   3                  {
  65   4                      if(KeyPara.PreKey == (Key_Steam|Key_Hotwater)) 
  66   4                      {
  67   5                          KeyPara.FilterCount = 0;
  68   5                          LT.CleanTask.Logictrl.LogictrlBit.quit=1;   
  69   5                          DeviceStatus = status_Idle;
  70   5                      }
  71   4                  }
  72   3              }
  73   2              else  if(KeyPara.FilterCount>= KeyDelay_3S)
  74   2              {
  75   3                  if(DeviceStatus == status_Idle)
  76   3                  {
  77   4                      if(KeyPara.PreKey == Key_Temp)
  78   4                      {
  79   5                          KeyPara.FilterCount = 0;
  80   5                          if(curTempUnit==CentigradeDis)  
  81   5                              curTempUnit = FahrenheitDis;
  82   5                          else
  83   5                              curTempUnit = CentigradeDis;
  84   5                      }
  85   4                  }
  86   3                  // else if (DeviceStatus == status_Work)
  87   3                  // {
  88   3                  //     if((KeyPara.PreKey == Key_Grind)&&(LT.GrindBeanTask.Logictrl.LogictrlBit.step==2))
  89   3                  //     {
  90   3                  //         KeyPara.FilterCount = 0;
  91   3                  //         LT.GrindBeanTask.Logictrl.LogictrlBit.quit=1;
  92   3                  //         DeviceStatus = status_Idle;
  93   3                  //     }
  94   3                  // }
  95   3             }
  96   2          }
  97   1          else 
  98   1          {
  99   2              KeyPara.FilterCount++;
 100   2              if(KeyPara.FilterCount>= KeyDelay_20MS)
 101   2              {
 102   3                  SleepCut = 0;
 103   3                  KeyPara.FilterCount = 0;
 104   3                  KeyPara.PreKey = KeyValue;
 105   3              }
 106   2          }
 107   1      }
 108          
 109          void Respone()
 110          {
 111   1         switch (KeyPara.CurKey)//å½“å‰é”®å€¼
 112   1         {
 113   2        //=====================================================================// 1
 114   2          case Key_Power://ç”µæº
 115   2          KeyPara.CurKey = 0;//æ¸…é™¤é”®å€¼
 116   2          if(DeviceStatus== status_Down)//å¦‚æœæ˜¯å…³æœº
C51 COMPILER V9.54   KEY                                                                   07/12/2025 08:10:59 PAGE 3   

 117   2          {
 118   3          //çŸ­æŒ‰â€œç”µæºâ€æŒ‰é”®è¿›è¡Œå¼€æœºï¼Œèœ‚é¸£1å£°ï¼ˆ0.5s/å£°ï¼‰ï¼Œâ€œç”µæºâ€æŒ‰é”®ç¯ç”±é—ªçƒè½¬ä¸º
             -é•¿äº®ï¼Œæ˜¾ç¤ºå±æ˜¾ç¤ºé»˜è®¤ç•Œé¢â€œæ„å¼å’–å•¡å•æ¯ï¼Œæ¸©åº¦92Câ€å‹åŠ›æ˜¾ç¤ºâ€œ00â€
 119   3              buzctrl.BeepState   = BeepOnce;
 120   3              buzctrl.BeepDuration= Buz_500MS;//èœ‚é¸£å™¨é¸£å“ä¸€å£°
 121   3              CurFuntion = SingleEspersso;//å½“å‰åŠŸèƒ½ä¸ºå•æ¯
 122   3              CurSettingTemp = &TempSingleEsp;//å½“å‰è®¾ç½®æ¸©åº¦
 123   3          
 124   3              Dis_Function(CurFuntion);//æ˜¾ç¤ºå½“å‰åŠŸèƒ½ç¯ï¼Œå³å•æ¯
 125   3              Dis_PilotLamp(Led_Power);//æ•°ç ç®¡ç¯
 126   3              Dis_Pressure(0,1);//æ˜¾ç¤ºå‹åŠ›
 127   3              LT.PotHeatTask.Logictrl.LogictrlBit.execute=1;//æ‰§è¡Œçƒ­æ°´åŠŸèƒ½
 128   3              DeviceStatus = status_Idle;//è¿›å…¥æ˜¾ç¤ºçŠ¶æ€
 129   3          }
 130   2          else if(DeviceStatus>status_Down)//å¦åˆ™å…³é—­æœºå™¨
 131   2          {
 132   3          AllDown();
 133   3          ErrCode =0;
 134   3              DeviceStatus = status_Down;//è¿›å…¥å…³é—­çŠ¶æ€
 135   3          }
 136   2          break;
 137   2        //=====================================================================// 2
 138   2          case Key_Grind://ç£¨è±†
 139   2          KeyPara.CurKey = 0;
 140   2          if(DeviceStatus== status_Idle)//æ˜¾ç¤ºä¸­
 141   2          {
 142   3              Dis_PilotLamp(Led_Power|Led_Grind);//æ˜¾ç¤ºç£¨è±†å’Œç”µæºç¯
 143   3              LT.GrindBeanTask.Logictrl.LogictrlBit.execute = 1; //æ‰§è¡Œç£¨è±†ä»»åŠ¡    
 144   3                  DeviceStatus  = status_Work;//è¿›å…¥å·¥ä½œçŠ¶æ€
 145   3          }
 146   2          else if (DeviceStatus == status_Work)//å·¥ä½œçŠ¶æ€
 147   2          {
 148   3              if(LT.GrindBeanTask.Logictrl.LogictrlBit.execute)//å…³é—­ç£¨è±†ä»»åŠ¡
 149   3              {
 150   4                  LT.GrindBeanTask.Logictrl.LogictrlBit.quit= 1;
 151   4                  DeviceStatus = status_Idle;//å›åˆ°æ˜¾ç¤ºæ¸©åº¦
 152   4              }
 153   3          }
 154   2          break;
 155   2        //=====================================================================// 3
 156   2          case Key_Temp://æ¸©åº¦æŒ‰é”®
 157   2          KeyPara.CurKey = 0;
 158   2          if(CurFuntion<ColdBrew)//ä¸æ˜¯å†·ç¿ åŠŸèƒ½
 159   2        ((*CurSettingTemp)==MaxCoffeTemp)?((*CurSettingTemp)=MinCoffeTemp):((*CurSettingTemp)++);//ä¸æ˜¯æœ€å¤§æ¸
             -©åº¦å€¼å°±å¢åŠ 
 160   2          break;
 161   2        //=====================================================================// 4
 162   2          case Key_Clean://æ¸…æ´æŒ‰é”®
 163   2          KeyPara.CurKey = 0;
 164   2          if(DeviceStatus == status_Idle)
 165   2          {
 166   3              // LT.CleanTask.Logictrl.LogictrlBit.execute = 1;
 167   3              LT.PipelineFlushingTask.Logictrl.LogictrlBit.execute = 1;//æ‰§è¡Œæ¸…æ´ä»»åŠ¡
 168   3              Dis_PilotLamp(Led_Power|Led_Clean);//ç‚¹äº®æ¸…æ´æŒ‡ç¤ºç¯
 169   3              DeviceStatus = status_Work;
 170   3          }
 171   2          else if(LT.PipelineFlushingTask.Logictrl.LogictrlBit.execute)
 172   2          {
 173   3                  LT.PipelineFlushingTask.Logictrl.LogictrlBit.quit= 1;
 174   3                  DeviceStatus = status_Idle;
 175   3          }
 176   2          break;
C51 COMPILER V9.54   KEY                                                                   07/12/2025 08:10:59 PAGE 4   

 177   2        //=====================================================================// 5
 178   2          case Key_Steam://è’¸æ±½æŒ‰é”®
 179   2          KeyPara.CurKey = 0;
 180   2          if(DeviceStatus == status_Idle)//å¦‚æœæ˜¯æ˜¾ç¤ºçŠ¶æ€
 181   2          {
 182   3              // LT.MakeSteamTask.Logictrl.LogictrlBit.execute = 1;
 183   3              // Dis_PilotLamp(Led_Power|Led_Steam|Led_Grind);
 184   3              DeviceStatus = status_Steam;//è·³è½¬åˆ°è’¸æ±½
 185   3          }
 186   2          else if (DeviceStatus == status_Steam)//å¦‚æœæ˜¯è’¸æ±½æ¨¡å¼ï¼Œé€€å‡ºä»»åŠ¡
 187   2          {
 188   3              if(LT.MakeSteamTask.Logictrl.LogictrlBit.execute)
 189   3              {
 190   4                  LT.MakeSteamTask.Logictrl.LogictrlBit.quit= 1;
 191   4                  DeviceStatus = status_Idle;
 192   4              }
 193   3              else 
 194   3                  LT.MakeSteamTask.Logictrl.LogictrlBit.execute = 1;  
 195   3          }
 196   2      
 197   2          break;
 198   2        //=====================================================================// 6
 199   2          case Key_Hotwater://çƒ­æ°´æŒ‰é”®
 200   2          KeyPara.CurKey = 0;
 201   2          if(DeviceStatus == status_Idle)
 202   2          {
 203   3              LT.MakeHotWaterTask.Logictrl.LogictrlBit.execute = 1;
 204   3              Dis_PilotLamp(Led_Power|Led_HotWater);
 205   3              DeviceStatus = status_Work;
 206   3          }
 207   2          else if (DeviceStatus == status_Work)
 208   2          {
 209   3              if(LT.MakeHotWaterTask.Logictrl.LogictrlBit.execute)
 210   3              {
 211   4                  LT.MakeHotWaterTask.Logictrl.LogictrlBit.quit= 1;
 212   4                  DeviceStatus = status_Idle;
 213   4              }
 214   3          }
 215   2          break;
 216   2        //=====================================================================// 7
 217   2          case Key_Extract://èƒå–æŒ‰é”®ï¼Œè¿›å…¥åˆ¶ä½œå’–å•¡å’Œé€€å‡ºåˆ¶ä½œå’–å•¡
 218   2          KeyPara.CurKey = 0;
 219   2          if(DeviceStatus == status_Idle)//å¦‚æœæ˜¯æ˜¾ç¤ºçŠ¶æ€ï¼Œåˆ™åˆ‡æ¢åˆ°å¯¹åº”çš„å·¥ä½œï¼Œè®¾ç½®å¥½ç›¸åº”
             -çš„æµé‡æ§åˆ¶å’Œé¢„æ³¨æ°´æ—¶é—´
 220   2          {
 221   3              if(CurFuntion==SingleEspersso)//åˆ‡æ¢åˆ°å•æ¯åŠŸèƒ½
 222   3              {
 223   4                  PreInjectionTime = PreSingleEspTime;//å•æ¯æµ“ç¼©é¢„æ³¨æ°´æ—¶é—´
 224   4                  MakeFlow = FlowSingleEspe; //å•æ¯æµ“ç¼©æµé‡
 225   4              }
 226   3              else if (CurFuntion==DoubleEspersso)
 227   3              {
 228   4                  PreInjectionTime = PreDoubleEspTime;
 229   4                  MakeFlow = FlowDoubleEsp;
 230   4              }
 231   3              else if (CurFuntion==Coffe)
 232   3              {
 233   4                  PreInjectionTime = PreCoffeeTime;
 234   4                  MakeFlow = FlowCoffee; 
 235   4              }
 236   3              else if (CurFuntion==Americano)
 237   3              {
C51 COMPILER V9.54   KEY                                                                   07/12/2025 08:10:59 PAGE 5   

 238   4                  PreInjectionTime = PreAmericanoTime;
 239   4                  MakeFlow = FlowAmericano; 
 240   4              }
 241   3              else if (CurFuntion==ColdBrew)
 242   3              {
 243   4                  MakeFlow = FlowColdBrew; 
 244   4              }
 245   3              else if (CurFuntion==EsperssoCool)
 246   3              {
 247   4                  PreInjectionTime = perEspCoolTime;
 248   4                  MakeFlow = FlowEspCool; 
 249   4              }
 250   3              Dis_PilotLamp(Led_Power);//æ˜¾ç¤ºç”µæºç¯
 251   3              LT.MakeCoffeTask.Logictrl.LogictrlBit.execute = 1;//åšå’–å•¡åŠŸèƒ½æ‰§è¡Œ
 252   3              DeviceStatus = status_Work;//å·¥ä½œçŠ¶æ€
 253   3          }
 254   2          else if (DeviceStatus == status_Work)//å¦‚æœåœ¨å·¥ä½œçŠ¶æ€
 255   2          {
 256   3              if(LT.MakeCoffeTask.Logictrl.LogictrlBit.execute)//é€€å‡ºåˆ¶ä½œå’–å•¡
 257   3              {
 258   4                  LT.MakeCoffeTask.Logictrl.LogictrlBit.quit= 1;
 259   4                  DeviceStatus = status_Idle;
 260   4              }
 261   3          }
 262   2          break;
 263   2         default:
 264   2          break;
 265   2         } 
 266   1      }
 267          
 268          //æ•°ç ç®¡æ‰«æ
 269          u8 ScanEncoder()
 270          {
 271   1         static bit Enc0,Enc1=0;
 272   1         static u8 EncOld,EncX=0;
 273   1         u8 EncNow=0;
 274   1         EnCoder_A =1;
 275   1         EnCoder_B =1;
 276   1         if(Enc0==0)EncOld=(EnCoder_A?0x02:0x00)+(EnCoder_B?0x01:0x00),Enc0 =1;
 277   1         EncNow=(EnCoder_A?0x02:0x00)+(EnCoder_B?0x01:0x00);
 278   1         if(EncNow == EncOld)return 0;
 279   1         if((EncOld==0x00&&EncNow==0x02)||(EncOld==0x03&&EncNow==0x01))EncX=EncNow;
 280   1         if((EncOld==0x00&&EncX==0x02&&EncNow ==0x03)||(EncOld==0x03&&EncX ==0x01&&EncNow==0x00))
 281   1         {
 282   2             EncOld =EncNow,EncX=0;
 283   2             if(Enc1==0)Enc1=1;
 284   2             else
 285   2             {
 286   3             Delay_us(150);
 287   3                 SleepCut = 0;
 288   3                 if(DeviceStatus == status_Idle)
 289   3                 {
 290   4                      (CurFuntion&SingleEspersso)?(CurFuntion=EsperssoCool):(CurFuntion>>=1);
 291   4                      switch(CurFuntion)
 292   4                      {
 293   5                          case SingleEspersso:
 294   5                          CurSettingTemp = &TempSingleEsp;
 295   5                          break;
 296   5                          case DoubleEspersso:
 297   5                          CurSettingTemp = &TempDoubleEsp;
 298   5                          break;
 299   5                          case Coffe:
C51 COMPILER V9.54   KEY                                                                   07/12/2025 08:10:59 PAGE 6   

 300   5                          CurSettingTemp = &TempCoffee;
 301   5                          break;
 302   5                          case Americano:
 303   5                          CurSettingTemp = &TempAmericano;
 304   5                          break;
 305   5                          case ColdBrew:
 306   5                          CurSettingTemp = &TempColdDrink;
 307   5                          break;
 308   5                          case EsperssoCool:
 309   5                          CurSettingTemp = &TempColdDrink;
 310   5                          break;
 311   5                      }
 312   4                 }
 313   3            else if ((LT.GrindBeanTask.Logictrl.LogictrlBit.step==2)&&LT.GrindBeanTask.Logictrl.LogictrlBit.execute
             -)
 314   3            {
 315   4              if(GrindTime>MinGrindTime)GrindTime--;
 316   4              TimerRes(&LT.GrindBeanTask.tm);
 317   4            }
 318   3                 Enc1 =0;
 319   3                 return Anticlockwise;
 320   3             }
 321   2         }
 322   1         if((EncOld==0x00&&EncNow==0x01)||(EncOld==0x03&&EncNow==0x02))EncX=EncNow;
 323   1         if((EncOld==0x00&&EncX==0x001&&EncNow==0x03)||(EncOld==0x03&&EncX==0x02&&EncNow==0x00))
 324   1         {
 325   2             EncOld=EncNow,EncX=0;
 326   2             if(Enc1==0)Enc1=1;
 327   2             else
 328   2             {
 329   3                  Delay_us(150);
 330   3                  SleepCut = 0;
 331   3                  if(DeviceStatus == status_Idle)
 332   3                  {
 333   4                      (CurFuntion&EsperssoCool)?(CurFuntion=SingleEspersso):(CurFuntion<<=1);
 334   4                      switch(CurFuntion)
 335   4                      {
 336   5                          case SingleEspersso:
 337   5                          CurSettingTemp = &TempSingleEsp;
 338   5                          break;
 339   5                          case DoubleEspersso:
 340   5                          CurSettingTemp = &TempDoubleEsp;
 341   5                          break;
 342   5                          case Coffe:
 343   5                          CurSettingTemp = &TempCoffee;
 344   5                          break;
 345   5                          case Americano:
 346   5                          CurSettingTemp = &TempAmericano;
 347   5                          break;
 348   5                          case ColdBrew:
 349   5                          CurSettingTemp = &TempColdDrink;
 350   5                          break;
 351   5                          case EsperssoCool:
 352   5                          CurSettingTemp = &TempColdDrink;
 353   5                          break;
 354   5                      }
 355   4                  }
 356   3                  else if ((LT.GrindBeanTask.Logictrl.LogictrlBit.step==2)&&LT.GrindBeanTask.Logictrl.LogictrlBi
             -t.execute)
 357   3                  {
 358   4                      if(GrindTime<MaxGrindTime)GrindTime++;
 359   4                      TimerRes(&LT.GrindBeanTask.tm);
C51 COMPILER V9.54   KEY                                                                   07/12/2025 08:10:59 PAGE 7   

 360   4                  }
 361   3                 Enc1 =0;
 362   3                 return Clockwise;
 363   3             }
 364   2         }
 365   1         return 0;
 366   1      }
 367          


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =   1363    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =      4    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =      2       2
   IDATA SIZE       =   ----    ----
   BIT SIZE         =      2    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
