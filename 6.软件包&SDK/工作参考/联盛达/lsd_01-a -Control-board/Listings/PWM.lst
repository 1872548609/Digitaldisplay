C51 COMPILER V9.54   PWM                                                                   07/12/2025 08:11:00 PAGE 1   


C51 COMPILER V9.54, COMPILATION OF MODULE PWM
OBJECT MODULE PLACED IN .\Objects\PWM.obj
COMPILER INVOKED BY: E:\keilC51\C51\BIN\C51.EXE scr\PWM.c OPTIMIZE(9,SIZE) BROWSE INCDIR(.\inc;.\USER) DEBUG OBJECTEXTEN
                    -D PRINT(.\Listings\PWM.lst) TABS(2) OBJECT(.\Objects\PWM.obj)

line level    source

   1          #include "OB38R16T1.h"
   2          #include "PWM.h"
   3          
   4          #define PWM_VECTOR  8           //PWM Interrupt Vevtor
   5          #define d_PWMCS     0x05        //PWMCS[2:0] (PWM clock select 0~7)
   6          #define d_PWMXEN    0x04        //PWM Channel Enable (0~F)
   7          #define d_PWM0PS    0x00        //PWM0 Channel polarity select
   8          #define d_PWM1PS    0x00        //PWM1 Channel polarity select
   9          #define d_PWM2PS    0x00        //PWM2 Channel polarity select
  10          #define d_PWM3PS    0x00        //PWM3 Channel polarity select
  11          #define d_PWMIE     0x00        //PWM Interrupt Enable bit
  12          #define d_PWMOMS    0x00
  13          #define d_DTP0      0x00
  14          #define d_DT0       0x00
  15          #define d_DTP1      0x00
  16          #define d_DT1       0x00
  17          
  18          #define PWMMD       0x03FF        //PWMMD[9:0]=Period (PWM Max Data Register 0~1023)
  19          unsigned int g_PWMD2 = 0x01ff;        //PWMD2[9:0]=Duty (PWM Channel 2 Data Register 0~1023)
  20          BuzCtrlType             buzctrl             ={0};
  21          
  22          void PWM_initialize(void)  //Initialize PWM
  23          {
  24   1          EA     = 0;             //Disable All Interrupt Function
  25   1          IEPWM  = (d_PWMIE);     //Enable PWM Interrupt Function
  26   1          PWMMDH = PWMMD >> 8;
  27   1          PWMMDL = PWMMD;
  28   1          PWMDT0 = (d_DTP0<<6) | d_DT0;
  29   1          PWMDT1 = (d_DTP1<<6) | d_DT1;
  30   1          PWMC2  = (d_PWM3PS<<3) | (d_PWM2PS<<2) | (d_PWM1PS<<1) | (d_PWM0PS) ;
  31   1          EA     = 1;             //Enable All Interrupt
  32   1      }
  33          
  34          void PWM_Output()
  35          {
  36   1          // PWMD0H = (PWMD0>>8);
  37   1          // PWMD0L = (PWMD0);
  38   1          // PWMD1H = (PWMD1>>8);
  39   1          // PWMD1L = (PWMD1);
  40   1          PWMD2H = (g_PWMD2>>8);
  41   1          PWMD2L = (g_PWMD2);
  42   1          // PWMD3H = (PWMD3>>8);
  43   1          // PWMD3L = (PWMD3);
  44   1          PWMC   = PWMC|(d_PWMCS<<5)|(d_PWMOMS<<4)|(d_PWMXEN);
  45   1      }
  46          
  47          void PWM_Disable(void)
  48          {
  49   1          IEPWM = 0;    //Disable PWM Interrupt
  50   1          PWMC  = 0;    //Disable PWM Function
  51   1      }
  52          
  53          void PWM_ISR(void) interrupt PWM_VECTOR //PWM Interrupt Subroutine
  54          {
C51 COMPILER V9.54   PWM                                                                   07/12/2025 08:11:00 PAGE 2   

  55   1          PWMIF = 0;
  56   1      }
  57          
  58          
  59          //蜂鸣器控制
  60          void BeepCtrl()
  61          {
  62   1        static u16 BeepCount=0;
  63   1          static u16 buzTime  =0;
  64   1          switch (buzctrl.BeepState)
  65   1          {
  66   2          case BeepDown:
  67   2          BeepCount=0;
  68   2              PWM_Disable();
  69   2              buzctrl.BeepState =0;
  70   2              break;
  71   2          case BeepOnce:
  72   2          BeepCount++;
  73   2          if(BeepCount<=buzctrl.BeepDuration)
  74   2            PWM_Output();
  75   2          else 
  76   2          {
  77   3            BeepCount=0;
  78   3            PWM_Disable();
  79   3            buzctrl.BeepState =0;
  80   3          }
  81   2              break;
  82   2          case BeepLoop:
  83   2              buzTime++;
  84   2          BeepCount++;
  85   2              if(buzTime<buzctrl.BeeTime)
  86   2              {
  87   3          if(BeepCount<buzctrl.BeepDuration)
  88   3            PWM_Output();
  89   3          else if(BeepCount<(buzctrl.BeepDuration+buzctrl.interval))
  90   3            PWM_Disable();
  91   3          else 
  92   3            BeepCount=0;
  93   3              }
  94   2              else
  95   2              {
  96   3                  buzTime=0;
  97   3            BeepCount=0;
  98   3            PWM_Disable();
  99   3            buzctrl.BeepState =0;
 100   3              }
 101   2              break;
 102   2          default:
 103   2          BeepCount=0;
 104   2          PWM_Disable();
 105   2          buzctrl.BeepState =0;
 106   2              break;
 107   2          }
 108   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    163    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =     13    ----
C51 COMPILER V9.54   PWM                                                                   07/12/2025 08:11:00 PAGE 3   

   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
